/**
 * @fileoverview Firestore Security Rules for the JustlyAI application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Only the authenticated user who "owns" a document (identified by their Firebase Auth UID) can read, create, update, or delete it.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, ensuring that all documents are scoped to a specific user. This structure simplifies authorization and prevents unauthorized access.
 *  - /users/{userId}: Stores user profile information, with the document ID matching the Firebase Auth UID.
 *  - /users/{userId}/chats/{chatId}: Stores chat conversations belonging to a specific user.
 *  - /users/{userId}/chats/{chatId}/messages/{messageId}: Stores messages within a specific chat conversation, owned by a specific user.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - All write operations (create, update, delete) are strictly controlled by ownership.
 *
 * Denormalization for Authorization:
 * The data structure itself denormalizes ownership by nesting all data under the /users/{userId} path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and the resource exists.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' can create their own profile document.
     *   Request: { auth: { uid: 'user_abc' }, resource: { data: { id: 'user_abc', email: 'test@example.com', displayName: 'Test User', createdAt: '2024-01-01T00:00:00Z' } } }
     * @deny (create) User with UID 'user_def' cannot create a profile document for user 'user_abc'.
     *   Request: { auth: { uid: 'user_def' }, resource: { data: { id: 'user_abc', email: 'test@example.com', displayName: 'Test User', createdAt: '2024-01-01T00:00:00Z' } } }
     * @allow (get) User with UID 'user_abc' can get their own profile document.
     *   Request: { auth: { uid: 'user_abc' } }
     * @deny (get) User with UID 'user_def' cannot get the profile document for user 'user_abc'.
     *   Request: { auth: { uid: 'user_def' } }
     * @principle Enforces document ownership for writes and restricts reads to the owner.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/chats/{chatId} collection.
     * @path /users/{userId}/chats/{chatId}
     * @allow (create) User with UID 'user_abc' can create a chat document in their own chats collection.
     *   Request: { auth: { uid: 'user_abc' }, resource: { data: { userId: 'user_abc', title: 'My Chat', createdAt: '2024-01-01T00:00:00Z', updatedAt: '2024-01-01T00:00:00Z' } } }
     * @deny (create) User with UID 'user_def' cannot create a chat document in user 'user_abc's chats collection.
     *   Request: { auth: { uid: 'user_def' }, resource: { data: { userId: 'user_abc', title: 'My Chat', createdAt: '2024-01-01T00:00:00Z', updatedAt: '2024-01-01T00:00:00Z' } } }
     * @allow (get) User with UID 'user_abc' can get a chat document in their own chats collection.
     *   Request: { auth: { uid: 'user_abc' } }
     * @deny (get) User with UID 'user_def' cannot get a chat document in user 'user_abc's chats collection.
     *   Request: { auth: { uid: 'user_def' } }
     * @principle Enforces document ownership for writes and restricts reads to the owner.
     */
    match /users/{userId}/chats/{chatId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/chats/{chatId}/messages/{messageId} collection.
     * @path /users/{userId}/chats/{chatId}/messages/{messageId}
     * @allow (create) User with UID 'user_abc' can create a message document in their own chats collection.
     *   Request: { auth: { uid: 'user_abc' }, resource: { data: { chatId: 'chat_123', senderId: 'user_abc', content: 'Hello!', timestamp: '2024-01-01T00:00:00Z' } } }
     * @deny (create) User with UID 'user_def' cannot create a message document in user 'user_abc's chats collection.
     *   Request: { auth: { uid: 'user_def' }, resource: { data: { chatId: 'chat_123', senderId: 'user_abc', content: 'Hello!', timestamp: '2024-01-01T00:00:00Z' } } }
     * @allow (get) User with UID 'user_abc' can get a message document in their own chats collection.
     *   Request: { auth: { uid: 'user_abc' } }
     * @deny (get) User with UID 'user_def' cannot get a message document in user 'user_abc's chats collection.
     *   Request: { auth: { uid: 'user_def' } }
     * @principle Enforces document ownership for writes and restricts reads to the owner.
     */
    match /users/{userId}/chats/{chatId}/messages/{messageId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.senderId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.senderId == resource.data.senderId;
      allow delete: if isExistingOwner(userId);
    }
  }
}